name: ðŸš€ Deploy to Azure
run-name: ðŸš€ Deploy to Azure (${{ inputs.environment || 'dev' }} - ${{ inputs.action || 'up' }})

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Action to perform'
        required: true
        default: 'up'
        type: choice
        options:
          - provision  # Infrastructure only
          - deploy     # Application only
          - up         # Both infrastructure and application
          - down       # Destroy everything

  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'src/**'
      - 'apps/**'
      - 'azure.yaml'
      - '.github/workflows/_template-deploy-azd.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'azure.yaml'
      - '.github/workflows/_template-deploy-azd.yml'

jobs:
  # ============================================================================
  # DEPLOY - Calls the reusable template workflow
  # ============================================================================
  deploy:
    name: ðŸš€ Deploy
    uses: ./.github/workflows/_template-deploy-azd.yml
    with:
      environment: ${{ inputs.environment || 'dev' }}
      action: ${{ inputs.action || 'up' }}
    secrets: inherit
