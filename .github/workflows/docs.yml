name: Deploy Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'pyproject.toml'
      - '.github/workflows/docs.yml'
  workflow_dispatch:
# Permissions for GitHub Actions deployment
permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # build:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Setup Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'

  #     - name: Install documentation dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -r requirements-docs.txt

  #     - name: Install minimal project dependencies
  #       run: |
  #         pip install fastapi pydantic uvicorn starlette
  #       continue-on-error: true

  #     - name: Setup Pages
  #       id: pages
  #       uses: actions/configure-pages@v4

  #     - name: Build documentation
  #       run: |
  #         mkdocs build --clean --strict
  #         touch ./site/.nojekyll
  #       env:
  #         AZURE_SPEECH_KEY: "dummy-key-for-docs"
  #         AZURE_SPEECH_REGION: "eastus"

  #     - name: Upload artifact
  #       uses: actions/upload-pages-artifact@v3
  #       with:
  #         path: ./site

  deploy:
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    # needs: build
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false     # critical: disables GITHUB_TOKEN for git


      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install docs dependencies
        run: |
          # Docs pipeline should install ONLY docs tooling.
          # Important: don't `uv sync` the project; that would install runtime deps we don't need.
          python - <<'PY'
          import pathlib
          import tomllib

          pyproject = pathlib.Path('pyproject.toml')
          data = tomllib.loads(pyproject.read_text(encoding='utf-8'))
          docs_deps = (
              data.get('project', {})
              .get('optional-dependencies', {})
              .get('docs', [])
          )
          if not docs_deps:
              raise SystemExit('No [project.optional-dependencies].docs found in pyproject.toml')

          req_path = pathlib.Path('requirements-docs.txt')
          req_path.write_text('\n'.join(docs_deps) + '\n', encoding='utf-8')
          print(f'Wrote {req_path} with {len(docs_deps)} dependencies')
          PY

          uv pip install -r requirements-docs.txt

      - name: Deploy docs
        uses: mhausenblas/mkdocs-deploy-gh-pages@1.26
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
          CONFIG_FILE: docs/mkdocs.yml
